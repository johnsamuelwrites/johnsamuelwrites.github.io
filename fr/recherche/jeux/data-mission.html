<!DOCTYPE html>
<html lang="fr">

        <head>
                <meta charset="utf-8" />
                <link href="../../../images/logo/favicon.png" rel="shortcut icon" />
                <meta content="width=device-width,initial-scale=1" name="viewport" />
                <meta name="description" content="Mission Données – un jeu de quête fantastique sur la science des données par John Samuel" />
                <title>Mission Données | John Samuel</title>
                <style>
                        /* ==============================
                           Thème Forêt Fantastique
                           ============================== */
                        :root {
                                --bg: #080f0a;
                                --p: #0f1a11;
                                --ink: #d4c9a4;
                                --m: #7a8c6e;
                                --a: #3d9e5e;
                                --a-bright: #4ade80;
                                --amber: #d97706;
                                --d: #991b1b;
                                --ok: #16a34a;
                                --l: rgba(61,158,94,0.22);
                                --glow: 0 0 12px rgba(61,158,94,0.35),0 0 24px rgba(61,158,94,0.15);
                                --glow-amber: 0 0 10px rgba(217,119,6,0.5)
                        }

                        * {
                                box-sizing: border-box
                        }

                        body {
                                margin: 0;
                                font-family: Segoe UI, Tahoma, sans-serif;
                                background: var(--bg);
                                color: var(--ink);
                                min-height: 100vh;
                                overflow-x: hidden
                        }

                        /* Atmosphère forêt profonde */
                        body::before {
                                content: '';
                                position: fixed;
                                inset: 0;
                                background:
                                        radial-gradient(ellipse at 15% 25%, rgba(34,85,51,0.2) 0%, transparent 55%),
                                        radial-gradient(ellipse at 85% 70%, rgba(24,62,38,0.18) 0%, transparent 55%),
                                        radial-gradient(ellipse at 50% 100%, rgba(217,119,6,0.07) 0%, transparent 40%);
                                z-index: -2;
                                animation: atm 14s ease-in-out infinite
                        }

                        /* Grille forêt subtile */
                        body::after {
                                content: '';
                                position: fixed;
                                inset: 0;
                                background-image:
                                        linear-gradient(rgba(61,158,94,0.04) 1px, transparent 1px),
                                        linear-gradient(90deg, rgba(61,158,94,0.04) 1px, transparent 1px);
                                background-size: 50px 50px;
                                z-index: -1;
                                pointer-events: none
                        }

                        @keyframes atm {
                                0%,100% { opacity:.7 }
                                50% { opacity:1 }
                        }

                        /* Lucioles */
                        .firefly {
                                position: fixed;
                                width: 4px;
                                height: 4px;
                                border-radius: 50%;
                                background: #ffd166;
                                box-shadow: 0 0 6px 2px rgba(255,209,102,0.8);
                                pointer-events: none;
                                z-index: 0;
                                animation: fly var(--dur,9s) ease-in-out infinite var(--del,0s)
                        }

                        @keyframes fly {
                                0%   { transform:translate(0,0) scale(1); opacity:0 }
                                20%  { opacity:.9 }
                                50%  { transform:translate(var(--dx,40px),var(--dy,-60px)) scale(1.3); opacity:.6 }
                                80%  { opacity:.7 }
                                100% { transform:translate(var(--dx2,-20px),var(--dy2,-110px)) scale(.7); opacity:0 }
                        }

                        /* === En-tête === */
                        .header {
                                position: sticky;
                                top: 0;
                                z-index: 100;
                                background: rgba(8,15,10,.85);
                                -webkit-backdrop-filter: blur(12px);
                                backdrop-filter: blur(12px);
                                border-bottom: 1px solid rgba(61,158,94,0.3);
                                box-shadow: 0 2px 16px rgba(0,0,0,.5)
                        }

                        .nav {
                                max-width: 1140px;
                                margin: 0 auto;
                                padding: 13px 18px;
                                display: flex;
                                justify-content: space-between;
                                align-items: center;
                                gap: 12px
                        }

                        .brand {
                                text-decoration: none;
                                font-weight: 700;
                                font-size: 1.15rem;
                                background: linear-gradient(135deg, #4ade80, #d97706);
                                -webkit-background-clip: text;
                                -webkit-text-fill-color: transparent;
                                background-clip: text
                        }

                        .crumbs {
                                color: var(--m);
                                font-size: .9rem
                        }

                        .crumbs a {
                                color: var(--a-bright);
                                text-decoration: none
                        }

                        .crumbs a:hover { text-decoration: underline }

                        /* === Mise en page === */
                        .app {
                                max-width: 1140px;
                                margin: 0 auto;
                                padding: 16px 18px;
                                position: relative;
                                z-index: 1
                        }

                        /* === Panneaux – clairières de forêt === */
                        .panel {
                                background: linear-gradient(145deg, rgba(15,26,17,.95), rgba(10,19,12,.9));
                                border: 1px solid var(--l);
                                border-radius: 12px;
                                padding: 14px;
                                margin-bottom: 12px;
                                box-shadow: 0 4px 20px rgba(0,0,0,.4), inset 0 1px 0 rgba(77,222,128,.05)
                        }

                        .top {
                                display: grid;
                                grid-template-columns: 1fr auto auto auto auto;
                                gap: 10px;
                                align-items: center
                        }

                        #title b {
                                background: linear-gradient(135deg, #4ade80, #d97706);
                                -webkit-background-clip: text;
                                -webkit-text-fill-color: transparent;
                                background-clip: text;
                                font-size: 1.05rem
                        }

                        .top > div {
                                color: var(--m);
                                font-size: .9rem
                        }

                        .top > div b { color: var(--ink) }

                        /* === Boutons – runes taillées === */
                        .btn {
                                border: 1px solid rgba(61,158,94,.35);
                                border-radius: 8px;
                                padding: 7px 13px;
                                background: rgba(15,26,17,.8);
                                color: var(--ink);
                                cursor: pointer;
                                font-family: Segoe UI, Tahoma, sans-serif;
                                font-size: .9rem;
                                transition: background .2s, box-shadow .2s, border-color .2s
                        }

                        .btn:hover:not(:disabled) {
                                background: rgba(61,158,94,.15);
                                border-color: var(--a-bright);
                                box-shadow: var(--glow)
                        }

                        .btn:disabled {
                                opacity: .35;
                                cursor: not-allowed
                        }

                        .pri {
                                background: linear-gradient(135deg, rgba(61,158,94,.4), rgba(45,138,78,.4));
                                border-color: var(--a);
                                color: #d4c9a4
                        }

                        .pri:hover:not(:disabled) {
                                background: linear-gradient(135deg, rgba(61,158,94,.65), rgba(45,138,78,.65))
                        }

                        .danger {
                                background: linear-gradient(135deg, rgba(153,27,27,.5), rgba(120,20,20,.5));
                                border-color: #991b1b;
                                color: #fca5a5
                        }

                        .danger:hover:not(:disabled) {
                                background: linear-gradient(135deg, rgba(185,28,28,.7), rgba(153,27,27,.7));
                                box-shadow: 0 0 12px rgba(185,28,28,.4);
                                border-color: #dc2626
                        }

                        h2 {
                                color: var(--a-bright);
                                font-size: 1rem;
                                margin: 0 0 10px;
                                text-transform: uppercase;
                                letter-spacing: .06em;
                                text-shadow: 0 0 8px rgba(74,222,128,.4)
                        }

                        h3 {
                                color: var(--ink);
                                font-size: .95rem;
                                margin: 0 0 8px
                        }

                        .grid2 {
                                display: grid;
                                grid-template-columns: 1fr 1fr;
                                gap: 12px
                        }

                        /* Phases disponibles */
                        .item {
                                border: 1px solid rgba(61,158,94,.2);
                                border-radius: 8px;
                                padding: 9px;
                                margin-bottom: 8px;
                                background: linear-gradient(135deg, rgba(21,34,25,.8), rgba(15,26,17,.8));
                                transition: border-color .2s, background .2s
                        }

                        .item:hover {
                                border-color: rgba(77,222,128,.4);
                                background: linear-gradient(135deg, rgba(27,46,32,.9), rgba(21,38,25,.9))
                        }

                        /* Phases sélectionnées */
                        .sel {
                                border: 1px solid rgba(61,158,94,.2);
                                border-radius: 8px;
                                padding: 9px;
                                margin-bottom: 8px;
                                display: grid;
                                grid-template-columns: 24px 1fr auto;
                                gap: 8px;
                                background: linear-gradient(135deg, rgba(21,34,25,.9), rgba(15,26,17,.9))
                        }

                        .wrong {
                                border-color: rgba(153,27,27,.6) !important;
                                background: linear-gradient(135deg, rgba(40,10,10,.9), rgba(30,8,8,.9)) !important
                        }

                        .tiny {
                                font-size: .82rem;
                                color: var(--m)
                        }

                        .status {
                                min-height: 22px;
                                font-size: .9rem
                        }

                        .bad { color: #f87171 }
                        .good { color: var(--a-bright) }
                        .hidden { display: none !important }

                        .ctrl {
                                display: grid;
                                grid-template-columns: auto auto auto 1fr;
                                gap: 8px;
                                align-items: center;
                                margin-bottom: 10px
                        }

                        select {
                                border: 1px solid rgba(61,158,94,.3);
                                border-radius: 8px;
                                padding: 7px 10px;
                                background: rgba(15,26,17,.9);
                                color: var(--ink);
                                font-family: Segoe UI, Tahoma, sans-serif;
                                font-size: .85rem
                        }

                        /* Tableau du pipeline */
                        .board {
                                display: grid;
                                grid-template-columns: repeat(5,minmax(170px,1fr));
                                gap: 10px;
                                overflow-x: auto
                        }

                        /* Colonnes – clairières de forêt */
                        .col {
                                border: 1px solid rgba(61,158,94,.2);
                                border-radius: 8px;
                                padding: 10px;
                                min-height: 200px;
                                background: linear-gradient(170deg, rgba(15,26,17,.9), rgba(10,19,12,.85));
                                transition: border-color .25s, box-shadow .25s
                        }

                        .col b {
                                color: var(--a-bright);
                                font-size: .9rem
                        }

                        .cur {
                                border-color: var(--a) !important;
                                box-shadow: 0 0 0 1px rgba(77,222,128,.3), inset 0 0 20px rgba(61,158,94,.08)
                        }

                        /* Unités de données – orbes lumineux */
                        .chips {
                                display: flex;
                                flex-wrap: wrap;
                                gap: 5px;
                                margin: 7px 0
                        }

                        .chip {
                                width: 11px;
                                height: 11px;
                                border-radius: 50%;
                                background: radial-gradient(circle at 35% 35%, #4ade80, #16a34a);
                                box-shadow: 0 0 8px rgba(74,222,128,.8), 0 0 16px rgba(74,222,128,.4);
                                animation: orb 2s ease-in-out infinite
                        }

                        @keyframes orb {
                                0%,100% { opacity:.75 }
                                50%     { opacity:1 }
                        }

                        /* Cartes problèmes – parchemins maudits */
                        .card {
                                width: 100%;
                                border: 1px solid rgba(153,27,27,.4);
                                border-radius: 8px;
                                padding: 7px;
                                text-align: left;
                                background: linear-gradient(135deg, rgba(30,12,12,.85), rgba(22,8,8,.85));
                                margin-bottom: 7px;
                                cursor: pointer;
                                color: #fca5a5;
                                font-family: Segoe UI, Tahoma, sans-serif;
                                font-size: .85rem;
                                transition: border-color .2s, box-shadow .2s
                        }

                        .card:hover {
                                border-color: rgba(220,38,38,.7);
                                box-shadow: 0 0 10px rgba(185,28,28,.3)
                        }

                        /* Fond modal */
                        .modalbg {
                                position: fixed;
                                inset: 0;
                                background: rgba(4,8,5,.8);
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                padding: 12px;
                                z-index: 200;
                                -webkit-backdrop-filter: blur(4px);
                                backdrop-filter: blur(4px)
                        }

                        /* Modal – tome ancien */
                        .modal {
                                width: min(580px,100%);
                                background: linear-gradient(160deg, #111e14, #0f1a11);
                                border: 1px solid rgba(61,158,94,.4);
                                border-radius: 12px;
                                padding: 18px;
                                box-shadow: 0 0 40px rgba(0,0,0,.6), var(--glow)
                        }

                        .modal h3 {
                                color: var(--amber);
                                font-size: 1.05rem;
                                margin: 0 0 10px;
                                text-shadow: var(--glow-amber)
                        }

                        .modal p {
                                color: var(--ink);
                                font-size: .92rem;
                                line-height: 1.55;
                                margin-bottom: 14px
                        }

                        .modal label {
                                color: var(--ink);
                                font-size: .9rem
                        }

                        .modal input[type=radio] { accent-color: var(--a-bright) }

                        /* Résumé – parchemin victoire/défaite */
                        .sum {
                                border: 1px solid rgba(61,158,94,.3);
                                border-radius: 8px;
                                padding: 14px;
                                background: linear-gradient(135deg, rgba(15,34,20,.95), rgba(10,22,13,.95));
                                margin-top: 10px;
                                box-shadow: var(--glow)
                        }

                        .sum h3 { color: var(--amber); text-shadow: var(--glow-amber); margin-bottom: 8px }
                        .sum p  { color: var(--ink); font-size: .92rem; margin-bottom: 6px }
                        .sum b  { color: var(--a-bright) }

                        /* === Pied de page === */
                        .footer-lang {
                                max-width: 1140px;
                                margin: 4px auto 28px;
                                padding: 0 18px;
                                text-align: center;
                                color: var(--m);
                                position: relative;
                                z-index: 1
                        }

                        .lang-switch {
                                display: inline-flex;
                                gap: 12px;
                                align-items: center;
                                border: 1px solid rgba(61,158,94,.25);
                                background: rgba(10,19,12,.7);
                                border-radius: 12px;
                                padding: 8px 14px
                        }

                        .lang-switch a {
                                color: var(--a-bright);
                                text-decoration: none;
                                font-weight: 600
                        }

                        .lang-switch a:hover { text-decoration: underline }
                        .lang-switch .active { color: var(--ink); pointer-events: none }
                        .lang-sep { color: var(--m) }

                        @media(max-width:900px) {
                                .top  { grid-template-columns: 1fr 1fr }
                                .grid2 { grid-template-columns: 1fr }
                                .ctrl { grid-template-columns: 1fr 1fr }
                                .board { grid-template-columns: repeat(5,minmax(220px,1fr)) }
                        }
                </style>
        </head>

        <body>
                <header class="header">
                        <nav class="nav" aria-label="Navigation principale">
                                <a class="brand" href="../index.html">John Samuel</a>
                                <div class="crumbs"><a href="./index.html">Recherche / Jeux</a> / Mission Données</div>
                        </nav>
                </header>

                <div class="app">
                        <section class="panel top">
                                <div id="title">
                                        <b>Mission Données</b>
                                </div>
                                <div>
                                        Minuteur : <b id="timer">25:00</b>
                                </div>
                                <div>
                                        Score : <b id="score">0</b>
                                </div>
                                <div>
                                        Phase courante : <b id="curLabel">N/A</b>
                                </div>
                                <button class="btn danger" id="restart" type="button">
                                        Recommencer
                                </button>
                        </section>

                        <section class="panel" id="build">
                                <h2>Construire le pipeline</h2>
                                <p class="tiny">Selectionnez les phases dans un ordre numerique croissant. Vous pouvez en ignorer.</p>
                                <div class="grid2">
                                        <div>
                                                <h3>Phases disponibles</h3>
                                                <div id="avail"></div>
                                        </div>
                                        <div>
                                                <h3>Sélection (<span id="selN">0</span>/5)</h3>
                                                <div id="sel"></div>
                                                <button class="btn pri" id="validate" type="button">
                                                        Valider le pipeline
                                                </button>
                                                <div class="status" id="bmsg"></div>
                                        </div>
                                </div>
                        </section>

                        <section class="panel hidden" id="play">
                                <h2>Jouer</h2>
                                <div class="ctrl">
                                        <button class="btn pri" id="roll" type="button">Lancer les dés</button>
                                        <button class="btn" id="move" type="button">Déplacer les données</button>
                                        <div>
                                                Déplacement : <b id="d1">-</b> | Problèmes : <b id="d2">-</b>
                                        </div>
                                        <label class="tiny">
                                                Générer dans : <select id="focus"></select>
                                        </label>
                                </div>
                                <div class="status" id="pmsg"></div>
                                <div class="board" id="board"></div>
                                <div class="sum hidden" id="summary"></div>
                        </section>
                </div>

                <div aria-hidden="true" class="modalbg hidden" id="mbg">
                        <div class="modal">
                                <h3 id="mt"></h3>
                                <p id="md"></p>
                                <form id="mf"></form>
                                <div class="status" id="mfb"></div>
                                <button class="btn pri" id="msub" type="button">Valider</button>
                                <button class="btn" id="mclose" type="button">Fermer</button>
                        </div>
                </div>

                <footer class="footer-lang" aria-label="Sélecteur de langue">
                        <div class="lang-switch">
                                <a href="../../../en/research/games/data-mission.html" hreflang="en"
                                        lang="en">EN</a><span class="lang-sep">|</span><span class="active">FR</span>
                        </div>
                </footer>

                <script>
                        // Générateur de lucioles
                        (function () {
                                for (let i = 0; i < 14; i++) {
                                        const f = document.createElement('div');
                                        f.className = 'firefly';
                                        f.style.cssText =
                                                'left:' + (Math.random() * 100) + 'vw;' +
                                                'top:' + (20 + Math.random() * 65) + 'vh;' +
                                                '--dur:' + (7 + Math.random() * 9) + 's;' +
                                                '--del:-' + (Math.random() * 12) + 's;' +
                                                '--dx:' + ((Math.random() - .5) * 130) + 'px;' +
                                                '--dy:-' + (30 + Math.random() * 90) + 'px;' +
                                                '--dx2:' + ((Math.random() - .5) * 80) + 'px;' +
                                                '--dy2:-' + (60 + Math.random() * 70) + 'px';
                                        document.body.appendChild(f);
                                }
                        })();

                        (async () => {
                                const $ = id => document.getElementById(id);
                                let c;
                                try {
                                        const response = await fetch('./config.json', { cache: 'no-cache' });
                                        if (!response.ok) throw new Error('HTTP ' + response.status);
                                        c = await response.json();
                                } catch (error) {
                                        console.error('Mission config load failed:', error);
                                        const err = $('bmsg') || $('pmsg');
                                        if (err) {
                                                err.textContent = 'Impossible de charger la configuration du jeu.';
                                                err.className = 'status bad';
                                        }
                                        return;
                                }
                                const by = Object.fromEntries(c.phases.map(p => [p.id, p]));
                                const phaseIdx = Object.fromEntries(c.phases.map((p, i) => [p.id, i + 1]));
                                const minSel = c.minSelectionCount ?? 2;
                                const maxSel = Math.min(c.maxSelectionCount ?? c.phases.length, c.phases.length);
                                const E = {
                                        title: $('title'), timer: $('timer'), score: $('score'), cur: $('curLabel'), build: $('build'), play: $('play'), avail: $('avail'), sel: $('sel'), selN: $('selN'), bmsg: $('bmsg'), pmsg: $('pmsg'), focus: $('focus'), board: $('board'), d1: $('d1'), d2: $('d2'), summary: $('summary'), mbg: $('mbg'), mt: $('mt'), md: $('md'), mf: $('mf'), mfb: $('mfb')
                                };
                                let T = null, S;
                                const r6 = () => Math.floor(Math.random() * 6) + 1, fmt = s => String(Math.floor(s / 60)).padStart(2, '0') + ':' + String(s % 60).padStart(2, '0');
                                const eq = (a, b) => a.length === b.length && a.every((v, i) => v === b[i]);
                                const curIdx = () => {
                                        if (!S.order.length) return null;
                                        for (let i = S.order.length - 2; i >= 0; i--) if (S.data[i] > 0) return i;
                                        return null
                                };
                                const unres = id => S.probs[id].length;
                                const msg = (el, t, k = '') => {
                                        el.textContent = t;
                                        el.className = 'status' + (k ? ' ' + k : '')
                                };
                                const pick = id => {
                                        const pool = by[id].problemPool, u = S.used[id];
                                        let a = pool.filter(p => !u.has(p.id));
                                        if (!a.length) {
                                                u.clear();
                                                a = pool.slice()
                                        }
                                        const p = a[Math.floor(Math.random() * a.length)];
                                        u.add(p.id);
                                        return p
                                };
                                const bonus = i => {
                                        if (i < 0 || i >= S.order.length) return;
                                        const id = S.order[i];
                                        if (S.clear[id]) return;
                                        if (S.data[i] === 0 && unres(id) === 0) {
                                                S.clear[id] = 1;
                                                S.score += c.scoring.phaseClearBonus;
                                                msg(E.pmsg, 'Bonus de phase +' + c.scoring.phaseClearBonus, 'good')
                                        }
                                };
                                const header = () => {
                                        E.title.innerHTML = '<b>' + c.gameTitle + '</b>';
                                        E.timer.textContent = fmt(S.time);
                                        E.score.textContent = S.score;
                                        const i = curIdx();
                                        E.cur.textContent = S.view !== 'play' ? 'N/A' : (i == null ? by[S.order[S.order.length - 1]].label : by[S.order[i]].label)
                                };
                                const openModal = (pid, uid) => {
                                        const p = S.probs[pid].find(x => x.uid === uid);
                                        if (!p) return;
                                        S.modal = { pid, uid };
                                        E.mt.textContent = p.title;
                                        E.md.textContent = p.description;
                                        E.mf.innerHTML = '';
                                        E.mfb.textContent = '';
                                        p.options.forEach((o, i) => {
                                                const l = document.createElement('label');
                                                l.style.display = 'block';
                                                l.style.marginBottom = '6px';
                                                l.innerHTML = '<input type="radio" name="a" value="' + i + '"> ' + o;
                                                E.mf.appendChild(l)
                                        });
                                        E.mbg.classList.remove('hidden');
                                        E.mbg.setAttribute('aria-hidden', 'false')
                                };
                                const closeModal = () => {
                                        S.modal = null;
                                        E.mbg.classList.add('hidden');
                                        E.mbg.setAttribute('aria-hidden', 'true')
                                };
                                const end = (win, reason) => {
                                        S.over = 1;
                                        S.win = win;
                                        S.reason = reason;
                                        clearInterval(T);
                                        T = null;
                                        if (win) S.score += c.scoring.winBonus;
                                        render()
                                };
                                const winCheck = () => {
                                        if (S.over || S.view !== 'play') return;
                                        const last = S.order.length - 1;
                                        if (S.data[last] === c.dataUnitsInitial && S.order.every(id => unres(id) === 0)) end(1, 'Toutes les données ont atteint la phase finale et tous les problèmes sont résolus.')
                                };
                                const reset = () => {
                                        if (T) clearInterval(T);
                                        S = {
                                                view: 'build', score: 0, time: c.timeLimitSeconds, sel: [], order: [], wrong: [], attempts: 0, wrongClicks: 0, data: [], probs: {
                                                }, used: {
                                                }, clear: {
                                                }, focus: '', round: {
                                                        rolled: 0, p: null, q: null, from: null, cap: ''
                                                }, modal: null, over: 0, win: 0, reason: ''
                                        };
                                        E.summary.classList.add('hidden');
                                        render()
                                };
                                const toPlay = () => {
                                        S.order = S.sel.slice();
                                        S.data = new Array(S.order.length).fill(0);
                                        S.data[0] = c.dataUnitsInitial;
                                        S.order.forEach(id => {
                                                S.probs[id] = [];
                                                S.used[id] = new Set();
                                                S.clear[id] = 0
                                        });
                                        S.focus = S.order[curIdx()] || S.order[0];
                                        S.view = 'play';
                                        msg(E.pmsg, 'Pipeline validé. Lancez les dés pour commencer.', 'good');
                                        T = setInterval(() => {
                                                if (S.over || S.view !== 'play') return;
                                                S.time--;
                                                if (S.time <= 0) {
                                                        S.time = 0;
                                                        end(0, 'Temps écoulé')
                                                }
                                                header()
                                        }, 1000)
                                };
                                const validate = () => {
                                        if (S.sel.length < minSel) {
                                                msg(E.bmsg, 'Selectionnez au moins ' + minSel + ' phases.', 'bad');
                                                return
                                        }
                                        S.attempts++;
                                        S.wrong = [];
                                        let badAt = -1;
                                        for (let i = 1; i < S.sel.length; i++) {
                                                if (phaseIdx[S.sel[i]] <= phaseIdx[S.sel[i - 1]]) {
                                                        badAt = i;
                                                        break;
                                                }
                                        }
                                        if (badAt !== -1) {
                                                S.score += c.scoring.pipelineWrongPenalty;
                                                S.wrong.push(badAt - 1, badAt);
                                                msg(E.bmsg, 'L ordre doit etre strictement croissant. ' + c.scoring.pipelineWrongPenalty + ' points.', 'bad');
                                                render();
                                                return
                                        }
                                        S.score += c.scoring.pipelineCorrectBonus;
                                        msg(E.bmsg, 'Pipeline valide ! +' + c.scoring.pipelineCorrectBonus, 'good');
                                        toPlay();
                                        render()
                                };
                                const gen = (id, n) => {
                                        const arr = S.probs[id], slots = Math.max(0, (c.maxProblemsPerPhase ?? c.maxProblemesPerPhase) - arr.length), k = Math.min(n, slots);
                                        for (let i = 0; i < k; i++) {
                                                const p = pick(id);
                                                arr.push({
                                                        uid: p.id + '_' + Date.now() + '_' + i + '_' + Math.floor(Math.random() * 99999), title: p.title, description: p.description, options: p.options.slice(), correctIndex: p.correctIndex, attempts: 0
                                                })
                                        }
                                        S.round.cap = k < n ? 'Cap reached' : ''
                                };
                                const roll = () => {
                                        if (S.over || S.view !== 'play') return;
                                        if (S.round.rolled) {
                                                msg(E.pmsg, 'Déplacez les données avant de relancer.', 'bad');
                                                return
                                        }
                                        const i = curIdx();
                                        if (i == null) {
                                                winCheck();
                                                msg(E.pmsg, 'Aucune donnée à déplacer.');
                                                return
                                        }
                                        const p = r6(), q = r6(), tid = S.focus || S.order[i], si = Math.max(0, S.order.indexOf(tid)), sid = S.order[si];
                                        S.round = { rolled: 1, p, q, from: i, cap: '' };
                                        gen(sid, q);
                                        msg(E.pmsg, 'Résultat de déplacement ' + p + ' et problèmes ' + q + (S.round.cap ? ' - ' + S.round.cap : ''), S.round.cap ? 'bad' : '');
                                        render()
                                };
                                const move = () => {
                                        if (S.over || S.view !== 'play') return;
                                        if (!S.round.rolled) {
                                                msg(E.pmsg, 'Lancez les dés d\'abord.', 'bad');
                                                return
                                        }
                                        const i = S.round.from;
                                        if (i == null || i >= S.order.length - 1) {
                                                S.round.rolled = 0;
                                                winCheck();
                                                render();
                                                return
                                        }
                                        const id = S.order[i];
                                        if (unres(id) > 0) {
                                                msg(E.pmsg, 'Déplacement bloqué : résolvez tous les problèmes dans ' + by[id].label + '.', 'bad');
                                                render();
                                                return
                                        }
                                        const m = Math.min(S.round.p, S.data[i]);
                                        if (m <= 0) {
                                                S.round.rolled = 0;
                                                msg(E.pmsg, 'Aucune donnée à déplacer.');
                                                render();
                                                return
                                        }
                                        S.data[i] -= m;
                                        S.data[i + 1] += m;
                                        bonus(i);
                                        S.round.rolled = 0;
                                        S.focus = S.order[curIdx()] || S.order[S.order.length - 1];
                                        msg(E.pmsg, 'Déplacement de ' + m + ' unité(s) de données.', 'good');
                                        winCheck();
                                        render()
                                };
                                const submit = () => {
                                        if (!S.modal) return;
                                        const sel = E.mf.querySelector('input[name="a"]:checked');
                                        if (!sel) {
                                                E.mfb.textContent = 'Sélectionnez une option d\'abord.';
                                                return
                                        }
                                        const a = Number(sel.value), {
                                                pid, uid
                                        } = S.modal, arr = S.probs[pid], i = arr.findIndex(x => x.uid === uid);
                                        if (i < 0) {
                                                closeModal();
                                                render();
                                                return
                                        }
                                        const p = arr[i];
                                        p.attempts++;
                                        if (a === p.correctIndex) {
                                                let g = c.scoring.laterCorrect;
                                                if (p.attempts === 1) g = c.scoring.firstClickCorrect;
                                                else if (p.attempts === 2) g = c.scoring.secondClickCorrect;
                                                S.score += g;
                                                arr.splice(i, 1);
                                                closeModal();
                                                msg(E.pmsg, 'Problème résolu dans ' + by[pid].label + '.', 'good');
                                                bonus(S.order.indexOf(pid));
                                                winCheck();
                                                render();
                                                return
                                        }
                                        S.score += c.scoring.wrongClickPenalty;
                                        S.wrongClicks++;
                                        E.mfb.textContent = 'Incorrect. ' + c.scoring.wrongClickPenalty + ' points. Réessayez.';
                                        header()
                                };
                                const renderBuild = () => {
                                        E.build.classList.toggle('hidden', S.view !== 'build');
                                        if (S.view !== 'build') return;
                                        E.selN.textContent = S.sel.length;
                                        E.avail.innerHTML = '';
                                        c.phases.forEach(p => {
                                                const d = document.createElement('div');
                                                d.className = 'item';
                                                const off = S.sel.includes(p.id) || S.sel.length >= maxSel;
                                                d.innerHTML = '<b>' + p.label + '</b><div class="tiny">' + p.shortDescription + '</div>';
                                                const b = document.createElement('button');
                                                b.className = 'btn';
                                                b.type = 'button';
                                                b.textContent = 'Ajouter';
                                                b.disabled = off;
                                                b.onclick = () => {
                                                        if (!off) {
                                                                S.sel.push(p.id);
                                                                S.wrong = [];
                                                                renderBuild()
                                                        }
                                                };
                                                d.appendChild(document.createElement('br'));
                                                d.appendChild(b);
                                                E.avail.appendChild(d)
                                        });
                                        E.sel.innerHTML = '';
                                        S.sel.forEach((id, i) => {
                                                const r = document.createElement('div');
                                                r.className = 'sel' + (S.wrong.includes(i) ? ' wrong' : '');
                                                r.innerHTML = '<b>' + (i + 1) + '.</b><div><b>' + by[id].label + '</b><div class="tiny">' + by[id].shortDescription + '</div></div>';
                                                const a = document.createElement('div');
                                                ['Monter', 'Descendre', 'Retirer'].forEach(t => {
                                                        const b = document.createElement('button');
                                                        b.className = 'btn';
                                                        b.type = 'button';
                                                        b.textContent = t;
                                                        b.disabled = (t === 'Monter' && i === 0) || (t === 'Descendre' && i === S.sel.length - 1);
                                                        b.onclick = () => {
                                                                if (t === 'Monter') [S.sel[i - 1], S.sel[i]] = [S.sel[i], S.sel[i - 1]];
                                                                if (t === 'Descendre') [S.sel[i + 1], S.sel[i]] = [S.sel[i], S.sel[i + 1]];
                                                                if (t === 'Retirer') S.sel.splice(i, 1);
                                                                S.wrong = [];
                                                                renderBuild()
                                                        };
                                                        a.appendChild(b)
                                                });
                                                r.appendChild(a);
                                                E.sel.appendChild(r)
                                        })
                                };
                                const renderPlay = () => {
                                        E.play.classList.toggle('hidden', S.view !== 'play');
                                        if (S.view !== 'play') return;
                                        E.d1.textContent = S.round.p ?? '-';
                                        E.d2.textContent = S.round.q ?? '-';
                                        E.focus.innerHTML = '';
                                        S.order.forEach(id => {
                                                const o = document.createElement('option');
                                                o.value = id;
                                                o.textContent = by[id].label;
                                                o.selected = id === S.focus;
                                                E.focus.appendChild(o)
                                        });
                                        const ci = curIdx(), blocked = ci != null && unres(S.order[ci]) > 0;
                                        $('roll').disabled = S.over || S.round.rolled;
                                        $('move').disabled = S.over || !S.round.rolled || blocked;
                                        E.board.innerHTML = '';
                                        S.order.forEach((id, i) => {
                                                const d = S.data[i] || 0, p = S.probs[id];
                                                const col = document.createElement('div');
                                                col.className = 'col' + (i === ci ? ' cur' : '');
                                                col.innerHTML = '<b>' + (i + 1) + '. ' + by[id].label + '</b><div class="tiny">Données : <b>' + d + '</b></div><div class="chips">' + new Array(d).fill('<span class="chip"></span>').join('') + '</div><div class="tiny">Problèmes : <b>' + p.length + '</b></div>';
                                                const w = document.createElement('div');
                                                p.forEach(x => {
                                                        const b = document.createElement('button');
                                                        b.type = 'button';
                                                        b.className = 'card';
                                                        b.textContent = x.title;
                                                        b.onclick = () => openModal(id, x.uid);
                                                        w.appendChild(b)
                                                });
                                                col.appendChild(w);
                                                E.board.appendChild(col)
                                        });
                                        if (S.over) {
                                                const used = c.timeLimitSeconds - S.time;
                                                E.summary.classList.remove('hidden');
                                                E.summary.innerHTML = '<h3>' + (S.win ? 'Mission accomplie' : 'Temps écoulé') + '</h3><p>' + S.reason + '</p><p><b>Score total :</b> ' + S.score + '</p><p><b>Temps utilisé :</b> ' + fmt(used) + '</p><p><b>Mauvais clics :</b> ' + S.wrongClicks + '</p><p><b>Tentatives du pipeline :</b> ' + S.attempts + '</p>'
                                        } else {
                                                E.summary.classList.add('hidden');
                                                E.summary.innerHTML = ''
                                        }
                                };
                                const render = () => {
                                        header();
                                        renderBuild();
                                        renderPlay()
                                };
                                $('validate').onclick = validate;
                                $('roll').onclick = roll;
                                $('move').onclick = move;
                                $('restart').onclick = reset;
                                E.focus.onchange = e => S.focus = e.target.value;
                                $('msub').onclick = submit;
                                $('mclose').onclick = closeModal;
                                E.mbg.onclick = e => {
                                        if (e.target === E.mbg) closeModal()
                                };
                                reset();
                        })();
                </script>
        </body>

</html>
